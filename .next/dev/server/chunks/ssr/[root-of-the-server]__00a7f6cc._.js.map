{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["file:///Users/miguelperdomoserrato/farmacias-vallenar-suit/src/lib/db.ts"],"sourcesContent":["import { Pool } from 'pg';\n\n// Disable SSL verification for self-signed certs in development\nif (process.env.NODE_ENV !== 'production') {\n    process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';\n}\n\nconst pool = new Pool({\n    // La conexión se sigue leyendo de la variable DATABASE_URL\n    connectionString: process.env.DATABASE_URL,\n    // [PARCHE CRÍTICO PARA EL ENTORNO LOCAL]\n    ssl: {\n        rejectUnauthorized: false,\n    },\n});\n\n// Handle idle client errors to prevent crash\npool.on('error', (err, client) => {\n    console.error('Unexpected error on idle client', err);\n    // Don't exit the process, just log it\n});\n\nexport async function query(text: string, params?: any[]) {\n    const start = Date.now();\n    try {\n        const res = await pool.query(text, params);\n        const duration = Date.now() - start;\n        console.log('Executed query', { text, duration, rows: res.rowCount });\n        return res;\n    } catch (error) {\n        console.warn('⚠️ Safe Mode: Database connection failed. Returning empty data.');\n        // console.error('Database Error:', error); // Uncomment for debugging\n        // Return a safe mock object to prevent app crash\n        return {\n            rows: [],\n            rowCount: 0,\n            command: '',\n            oid: 0,\n            fields: []\n        };\n    }\n}\n\nexport default pool;\n"],"names":[],"mappings":";;;;;;AAAA;;;;;;AAEA,gEAAgE;AAChE,wCAA2C;IACvC,QAAQ,GAAG,CAAC,4BAA4B,GAAG;AAC/C;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IAClB,2DAA2D;IAC3D,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,yCAAyC;IACzC,KAAK;QACD,oBAAoB;IACxB;AACJ;AAEA,6CAA6C;AAC7C,KAAK,EAAE,CAAC,SAAS,CAAC,KAAK;IACnB,QAAQ,KAAK,CAAC,mCAAmC;AACjD,sCAAsC;AAC1C;AAEO,eAAe,MAAM,IAAY,EAAE,MAAc;IACpD,MAAM,QAAQ,KAAK,GAAG;IACtB,IAAI;QACA,MAAM,MAAM,MAAM,KAAK,KAAK,CAAC,MAAM;QACnC,MAAM,WAAW,KAAK,GAAG,KAAK;QAC9B,QAAQ,GAAG,CAAC,kBAAkB;YAAE;YAAM;YAAU,MAAM,IAAI,QAAQ;QAAC;QACnE,OAAO;IACX,EAAE,OAAO,OAAO;QACZ,QAAQ,IAAI,CAAC;QACb,sEAAsE;QACtE,iDAAiD;QACjD,OAAO;YACH,MAAM,EAAE;YACR,UAAU;YACV,SAAS;YACT,KAAK;YACL,QAAQ,EAAE;QACd;IACJ;AACJ;uCAEe"}},
    {"offset": {"line": 77, "column": 0}, "map": {"version":3,"sources":["file:///Users/miguelperdomoserrato/farmacias-vallenar-suit/src/actions/dashboard.ts"],"sourcesContent":["'use server';\n\nimport { query } from '@/lib/db';\n\nexport interface DashboardMetrics {\n    salesToday: number;\n    ticketCount: number;\n    criticalStock: number;\n    expiringBatches: number;\n    coldChainStatus: 'Estable' | 'Alerta';\n}\n\nexport async function getDashboardMetrics(): Promise<DashboardMetrics> {\n    try {\n        // 1. Sales Today & Ticket Count\n        const salesSql = `\n            SELECT \n                COALESCE(SUM(total), 0) as total_sales, \n                COUNT(*) as ticket_count \n            FROM ventas \n            WHERE DATE(fecha) = CURRENT_DATE\n        `;\n        const salesResult = await query(salesSql);\n        const salesToday = salesResult.rows.length > 0 ? parseInt(salesResult.rows[0].total_sales || '0') : 0;\n        const ticketCount = salesResult.rows.length > 0 ? parseInt(salesResult.rows[0].ticket_count || '0') : 0;\n\n        // 2. Critical Stock (Products with < 10 units)\n        // We sum up lots for each product\n        const stockSql = `\n            SELECT COUNT(*) as critical_count \n            FROM (\n                SELECT p.id, COALESCE(SUM(l.cantidad_disponible), 0) as total_stock \n                FROM productos p \n                LEFT JOIN lotes l ON p.id = l.producto_id \n                GROUP BY p.id\n            ) as stocks \n            WHERE total_stock < 10\n        `;\n        const stockResult = await query(stockSql);\n        const criticalStock = stockResult.rows.length > 0 ? parseInt(stockResult.rows[0].critical_count || '0') : 0;\n\n        // 3. Expiring Batches (Next 30 days)\n        const expiringSql = `\n            SELECT COUNT(*) as expiring_count\n            FROM lotes\n            WHERE fecha_vencimiento <= CURRENT_DATE + INTERVAL '30 days'\n            AND cantidad_disponible > 0\n        `;\n        const expiringResult = await query(expiringSql);\n        const expiringBatches = expiringResult.rows.length > 0 ? parseInt(expiringResult.rows[0].expiring_count || '0') : 0;\n\n        return {\n            salesToday,\n            ticketCount,\n            criticalStock,\n            expiringBatches,\n            coldChainStatus: 'Estable' // Mocked for now\n        };\n    } catch (error) {\n        console.error('Error fetching dashboard metrics:', error);\n        return {\n            salesToday: 0,\n            ticketCount: 0,\n            criticalStock: 0,\n            expiringBatches: 0,\n            coldChainStatus: 'Estable'\n        };\n    }\n}\n"],"names":[],"mappings":";;;;;AAEA;;;;;;;;AAUO,eAAe;IAClB,IAAI;QACA,gCAAgC;QAChC,MAAM,WAAW,CAAC;;;;;;QAMlB,CAAC;QACD,MAAM,cAAc,MAAM,IAAA,yHAAK,EAAC;QAChC,MAAM,aAAa,YAAY,IAAI,CAAC,MAAM,GAAG,IAAI,SAAS,YAAY,IAAI,CAAC,EAAE,CAAC,WAAW,IAAI,OAAO;QACpG,MAAM,cAAc,YAAY,IAAI,CAAC,MAAM,GAAG,IAAI,SAAS,YAAY,IAAI,CAAC,EAAE,CAAC,YAAY,IAAI,OAAO;QAEtG,+CAA+C;QAC/C,kCAAkC;QAClC,MAAM,WAAW,CAAC;;;;;;;;;QASlB,CAAC;QACD,MAAM,cAAc,MAAM,IAAA,yHAAK,EAAC;QAChC,MAAM,gBAAgB,YAAY,IAAI,CAAC,MAAM,GAAG,IAAI,SAAS,YAAY,IAAI,CAAC,EAAE,CAAC,cAAc,IAAI,OAAO;QAE1G,qCAAqC;QACrC,MAAM,cAAc,CAAC;;;;;QAKrB,CAAC;QACD,MAAM,iBAAiB,MAAM,IAAA,yHAAK,EAAC;QACnC,MAAM,kBAAkB,eAAe,IAAI,CAAC,MAAM,GAAG,IAAI,SAAS,eAAe,IAAI,CAAC,EAAE,CAAC,cAAc,IAAI,OAAO;QAElH,OAAO;YACH;YACA;YACA;YACA;YACA,iBAAiB,UAAU,iBAAiB;QAChD;IACJ,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,qCAAqC;QACnD,OAAO;YACH,YAAY;YACZ,aAAa;YACb,eAAe;YACf,iBAAiB;YACjB,iBAAiB;QACrB;IACJ;AACJ;;;IAxDsB;;AAAA,+OAAA"}},
    {"offset": {"line": 156, "column": 0}, "map": {"version":3,"sources":["file:///Users/miguelperdomoserrato/farmacias-vallenar-suit/src/actions/operations.ts"],"sourcesContent":["'use server';\n\nimport { query } from '@/lib/db';\nimport { revalidatePath } from 'next/cache';\n\n// --- Shift Management ---\n\nexport async function getShiftStatus() {\n    try {\n        const sql = `SELECT valor FROM configuracion_global WHERE clave = 'en_turno'`;\n        const res = await query(sql);\n        return res.rows.length > 0 ? res.rows[0].valor === 'true' : false;\n    } catch (error) {\n        console.error('Error getting shift status:', error);\n        return false;\n    }\n}\n\nexport async function toggleShift(isOpen: boolean) {\n    try {\n        const sql = `\n            INSERT INTO configuracion_global (clave, valor) \n            VALUES ('en_turno', $1) \n            ON CONFLICT (clave) \n            DO UPDATE SET valor = $1, updated_at = CURRENT_TIMESTAMP\n        `;\n        await query(sql, [String(isOpen)]);\n        revalidatePath('/');\n        return { success: true };\n    } catch (error) {\n        console.error('Error toggling shift:', error);\n        return { success: false, error: 'Failed to update shift status' };\n    }\n}\n\n// --- Time Clock (Asistencia) ---\n\nexport async function clockIn(userId: number) {\n    try {\n        // Check if already clocked in today without clock out\n        const checkSql = `\n            SELECT id FROM asistencia \n            WHERE usuario_id = $1 AND fecha = CURRENT_DATE AND hora_salida IS NULL\n        `;\n        const checkRes = await query(checkSql, [userId]);\n\n        if (checkRes.rows.length > 0) {\n            return { success: false, error: 'Ya has marcado entrada hoy.' };\n        }\n\n        const sql = `\n            INSERT INTO asistencia (usuario_id, fecha, hora_entrada, estado)\n            VALUES ($1, CURRENT_DATE, CURRENT_TIME, 'presente')\n        `;\n        await query(sql, [userId]);\n        revalidatePath('/');\n        return { success: true };\n    } catch (error) {\n        console.error('Error clocking in:', error);\n        return { success: false, error: 'Error al marcar entrada' };\n    }\n}\n\nexport async function clockOut(userId: number) {\n    try {\n        const sql = `\n            UPDATE asistencia \n            SET hora_salida = CURRENT_TIME, estado = 'finalizado'\n            WHERE usuario_id = $1 AND fecha = CURRENT_DATE AND hora_salida IS NULL\n        `;\n        const res = await query(sql, [userId]);\n\n        if (res.rowCount === 0) {\n            return { success: false, error: 'No tienes una entrada activa para marcar salida.' };\n        }\n\n        revalidatePath('/');\n        return { success: true };\n    } catch (error) {\n        console.error('Error clocking out:', error);\n        return { success: false, error: 'Error al marcar salida' };\n    }\n}\n\n// --- Queue System (Totem) ---\n\nexport async function generateTicket(type: 'GENERAL' | 'PREFERENCIAL' | 'CAJA') {\n    try {\n        // 1. Get current number for today\n        const countSql = `SELECT COUNT(*) as count FROM cola_atencion WHERE DATE(created_at) = CURRENT_DATE`;\n        const countRes = await query(countSql);\n        const nextNum = parseInt(countRes.rows[0].count || '0') + 1;\n\n        const prefix = type === 'PREFERENCIAL' ? 'P' : type === 'CAJA' ? 'C' : 'A';\n        const ticketNumber = `${prefix}-${nextNum.toString().padStart(3, '0')}`;\n\n        // 2. Insert ticket\n        const insertSql = `\n            INSERT INTO cola_atencion (numero_ticket, tipo, estado)\n            VALUES ($1, $2, 'espera')\n            RETURNING id, numero_ticket, created_at\n        `;\n        const res = await query(insertSql, [ticketNumber, type]);\n\n        revalidatePath('/totem');\n        return { success: true, ticket: res.rows[0] };\n    } catch (error) {\n        console.error('Error generating ticket:', error);\n        return { success: false, error: 'Error al generar ticket' };\n    }\n}\n\nexport async function getNextTicket(counterId: number) {\n    try {\n        // Find oldest ticket in 'espera'\n        const findSql = `\n            SELECT id, numero_ticket FROM cola_atencion \n            WHERE estado = 'espera' \n            ORDER BY created_at ASC \n            LIMIT 1\n        `;\n        const findRes = await query(findSql);\n\n        if (findRes.rows.length === 0) {\n            return { success: false, message: 'No hay clientes en espera' };\n        }\n\n        const ticket = findRes.rows[0];\n\n        // Update ticket to 'llamando' or 'atendiendo'\n        const updateSql = `\n            UPDATE cola_atencion \n            SET estado = 'llamando', modulo_atencion = $1, updated_at = CURRENT_TIMESTAMP\n            WHERE id = $2\n        `;\n        await query(updateSql, [counterId, ticket.id]);\n\n        revalidatePath('/');\n        return { success: true, ticket };\n    } catch (error) {\n        console.error('Error calling next ticket:', error);\n        return { success: false, error: 'Error al llamar siguiente número' };\n    }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 370, "column": 0}, "map": {"version":3,"sources":["file:///Users/miguelperdomoserrato/farmacias-vallenar-suit/.next-internal/server/app/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {getDashboardMetrics as '00d3da74548a9b500601edf7f88390a057ffaf3f00'} from 'ACTIONS_MODULE0'\nexport {getShiftStatus as '00632a3f0875c4bf901d7a172525d2bb04add39dbb'} from 'ACTIONS_MODULE1'\nexport {toggleShift as '406ac90d3a46e58b5a99b286606ba5d4c8ba36a755'} from 'ACTIONS_MODULE1'\nexport {clockIn as '40105bd81065da0ccc3a45a65f5c8d0dd8ab647c13'} from 'ACTIONS_MODULE1'\nexport {clockOut as '4089f4845c7c8873c905318e97804bd95f7e1fbb40'} from 'ACTIONS_MODULE1'\nexport {generateTicket as '40e42e4061da824f3808174c8bed605b592635ef6f'} from 'ACTIONS_MODULE1'\nexport {getNextTicket as '40f5ca8e08720eb62fda68a1a62a5649468867e81f'} from 'ACTIONS_MODULE1'\n"],"names":[],"mappings":";AAAA;AACA"}}]
}