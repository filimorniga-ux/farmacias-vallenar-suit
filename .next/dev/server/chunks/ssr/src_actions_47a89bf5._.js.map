{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":""}},
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["file:///Users/miguelperdomoserrato/farmacias-vallenar-suit/src/actions/operations.ts"],"sourcesContent":["'use server';\n\nimport { query } from '@/lib/db';\nimport { revalidatePath } from 'next/cache';\n\n// --- Shift Management ---\n\nexport async function getShiftStatus() {\n    try {\n        const sql = `SELECT valor FROM configuracion_global WHERE clave = 'en_turno'`;\n        const res = await query(sql);\n        return res.rows.length > 0 ? res.rows[0].valor === 'true' : false;\n    } catch (error) {\n        console.error('Error getting shift status:', error);\n        return false;\n    }\n}\n\nexport async function toggleShift(isOpen: boolean) {\n    try {\n        const sql = `\n            INSERT INTO configuracion_global (clave, valor) \n            VALUES ('en_turno', $1) \n            ON CONFLICT (clave) \n            DO UPDATE SET valor = $1, updated_at = CURRENT_TIMESTAMP\n        `;\n        await query(sql, [String(isOpen)]);\n        revalidatePath('/');\n        return { success: true };\n    } catch (error) {\n        console.error('Error toggling shift:', error);\n        return { success: false, error: 'Failed to update shift status' };\n    }\n}\n\n// --- Time Clock (Asistencia) ---\n\nexport async function clockIn(userId: number) {\n    try {\n        // Check if already clocked in today without clock out\n        const checkSql = `\n            SELECT id FROM asistencia \n            WHERE usuario_id = $1 AND fecha = CURRENT_DATE AND hora_salida IS NULL\n        `;\n        const checkRes = await query(checkSql, [userId]);\n\n        if (checkRes.rows.length > 0) {\n            return { success: false, error: 'Ya has marcado entrada hoy.' };\n        }\n\n        const sql = `\n            INSERT INTO asistencia (usuario_id, fecha, hora_entrada, estado)\n            VALUES ($1, CURRENT_DATE, CURRENT_TIME, 'presente')\n        `;\n        await query(sql, [userId]);\n        revalidatePath('/');\n        return { success: true };\n    } catch (error) {\n        console.error('Error clocking in:', error);\n        return { success: false, error: 'Error al marcar entrada' };\n    }\n}\n\nexport async function clockOut(userId: number) {\n    try {\n        const sql = `\n            UPDATE asistencia \n            SET hora_salida = CURRENT_TIME, estado = 'finalizado'\n            WHERE usuario_id = $1 AND fecha = CURRENT_DATE AND hora_salida IS NULL\n        `;\n        const res = await query(sql, [userId]);\n\n        if (res.rowCount === 0) {\n            return { success: false, error: 'No tienes una entrada activa para marcar salida.' };\n        }\n\n        revalidatePath('/');\n        return { success: true };\n    } catch (error) {\n        console.error('Error clocking out:', error);\n        return { success: false, error: 'Error al marcar salida' };\n    }\n}\n\n// --- Queue System (Totem) ---\n\nexport async function generateTicket(type: 'GENERAL' | 'PREFERENCIAL' | 'CAJA') {\n    try {\n        // 1. Get current number for today\n        const countSql = `SELECT COUNT(*) as count FROM cola_atencion WHERE DATE(created_at) = CURRENT_DATE`;\n        const countRes = await query(countSql);\n        const nextNum = parseInt(countRes.rows[0].count || '0') + 1;\n\n        const prefix = type === 'PREFERENCIAL' ? 'P' : type === 'CAJA' ? 'C' : 'A';\n        const ticketNumber = `${prefix}-${nextNum.toString().padStart(3, '0')}`;\n\n        // 2. Insert ticket\n        const insertSql = `\n            INSERT INTO cola_atencion (numero_ticket, tipo, estado)\n            VALUES ($1, $2, 'espera')\n            RETURNING id, numero_ticket, created_at\n        `;\n        const res = await query(insertSql, [ticketNumber, type]);\n\n        revalidatePath('/totem');\n        return { success: true, ticket: res.rows[0] };\n    } catch (error) {\n        console.error('Error generating ticket:', error);\n        return { success: false, error: 'Error al generar ticket' };\n    }\n}\n\nexport async function getNextTicket(counterId: number) {\n    try {\n        // Find oldest ticket in 'espera'\n        const findSql = `\n            SELECT id, numero_ticket FROM cola_atencion \n            WHERE estado = 'espera' \n            ORDER BY created_at ASC \n            LIMIT 1\n        `;\n        const findRes = await query(findSql);\n\n        if (findRes.rows.length === 0) {\n            return { success: false, message: 'No hay clientes en espera' };\n        }\n\n        const ticket = findRes.rows[0];\n\n        // Update ticket to 'llamando' or 'atendiendo'\n        const updateSql = `\n            UPDATE cola_atencion \n            SET estado = 'llamando', modulo_atencion = $1, updated_at = CURRENT_TIMESTAMP\n            WHERE id = $2\n        `;\n        await query(updateSql, [counterId, ticket.id]);\n\n        revalidatePath('/');\n        return { success: true, ticket };\n    } catch (error) {\n        console.error('Error calling next ticket:', error);\n        return { success: false, error: 'Error al llamar siguiente número' };\n    }\n}\n"],"names":[],"mappings":";;;;;;;IAOsB,iBAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA"}},
    {"offset": {"line": 28, "column": 0}, "map": {"version":3,"sources":["file:///Users/miguelperdomoserrato/farmacias-vallenar-suit/src/actions/operations.ts"],"sourcesContent":["'use server';\n\nimport { query } from '@/lib/db';\nimport { revalidatePath } from 'next/cache';\n\n// --- Shift Management ---\n\nexport async function getShiftStatus() {\n    try {\n        const sql = `SELECT valor FROM configuracion_global WHERE clave = 'en_turno'`;\n        const res = await query(sql);\n        return res.rows.length > 0 ? res.rows[0].valor === 'true' : false;\n    } catch (error) {\n        console.error('Error getting shift status:', error);\n        return false;\n    }\n}\n\nexport async function toggleShift(isOpen: boolean) {\n    try {\n        const sql = `\n            INSERT INTO configuracion_global (clave, valor) \n            VALUES ('en_turno', $1) \n            ON CONFLICT (clave) \n            DO UPDATE SET valor = $1, updated_at = CURRENT_TIMESTAMP\n        `;\n        await query(sql, [String(isOpen)]);\n        revalidatePath('/');\n        return { success: true };\n    } catch (error) {\n        console.error('Error toggling shift:', error);\n        return { success: false, error: 'Failed to update shift status' };\n    }\n}\n\n// --- Time Clock (Asistencia) ---\n\nexport async function clockIn(userId: number) {\n    try {\n        // Check if already clocked in today without clock out\n        const checkSql = `\n            SELECT id FROM asistencia \n            WHERE usuario_id = $1 AND fecha = CURRENT_DATE AND hora_salida IS NULL\n        `;\n        const checkRes = await query(checkSql, [userId]);\n\n        if (checkRes.rows.length > 0) {\n            return { success: false, error: 'Ya has marcado entrada hoy.' };\n        }\n\n        const sql = `\n            INSERT INTO asistencia (usuario_id, fecha, hora_entrada, estado)\n            VALUES ($1, CURRENT_DATE, CURRENT_TIME, 'presente')\n        `;\n        await query(sql, [userId]);\n        revalidatePath('/');\n        return { success: true };\n    } catch (error) {\n        console.error('Error clocking in:', error);\n        return { success: false, error: 'Error al marcar entrada' };\n    }\n}\n\nexport async function clockOut(userId: number) {\n    try {\n        const sql = `\n            UPDATE asistencia \n            SET hora_salida = CURRENT_TIME, estado = 'finalizado'\n            WHERE usuario_id = $1 AND fecha = CURRENT_DATE AND hora_salida IS NULL\n        `;\n        const res = await query(sql, [userId]);\n\n        if (res.rowCount === 0) {\n            return { success: false, error: 'No tienes una entrada activa para marcar salida.' };\n        }\n\n        revalidatePath('/');\n        return { success: true };\n    } catch (error) {\n        console.error('Error clocking out:', error);\n        return { success: false, error: 'Error al marcar salida' };\n    }\n}\n\n// --- Queue System (Totem) ---\n\nexport async function generateTicket(type: 'GENERAL' | 'PREFERENCIAL' | 'CAJA') {\n    try {\n        // 1. Get current number for today\n        const countSql = `SELECT COUNT(*) as count FROM cola_atencion WHERE DATE(created_at) = CURRENT_DATE`;\n        const countRes = await query(countSql);\n        const nextNum = parseInt(countRes.rows[0].count || '0') + 1;\n\n        const prefix = type === 'PREFERENCIAL' ? 'P' : type === 'CAJA' ? 'C' : 'A';\n        const ticketNumber = `${prefix}-${nextNum.toString().padStart(3, '0')}`;\n\n        // 2. Insert ticket\n        const insertSql = `\n            INSERT INTO cola_atencion (numero_ticket, tipo, estado)\n            VALUES ($1, $2, 'espera')\n            RETURNING id, numero_ticket, created_at\n        `;\n        const res = await query(insertSql, [ticketNumber, type]);\n\n        revalidatePath('/totem');\n        return { success: true, ticket: res.rows[0] };\n    } catch (error) {\n        console.error('Error generating ticket:', error);\n        return { success: false, error: 'Error al generar ticket' };\n    }\n}\n\nexport async function getNextTicket(counterId: number) {\n    try {\n        // Find oldest ticket in 'espera'\n        const findSql = `\n            SELECT id, numero_ticket FROM cola_atencion \n            WHERE estado = 'espera' \n            ORDER BY created_at ASC \n            LIMIT 1\n        `;\n        const findRes = await query(findSql);\n\n        if (findRes.rows.length === 0) {\n            return { success: false, message: 'No hay clientes en espera' };\n        }\n\n        const ticket = findRes.rows[0];\n\n        // Update ticket to 'llamando' or 'atendiendo'\n        const updateSql = `\n            UPDATE cola_atencion \n            SET estado = 'llamando', modulo_atencion = $1, updated_at = CURRENT_TIMESTAMP\n            WHERE id = $2\n        `;\n        await query(updateSql, [counterId, ticket.id]);\n\n        revalidatePath('/');\n        return { success: true, ticket };\n    } catch (error) {\n        console.error('Error calling next ticket:', error);\n        return { success: false, error: 'Error al llamar siguiente número' };\n    }\n}\n"],"names":[],"mappings":";;;;;;;IAkBsB,cAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA"}},
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/miguelperdomoserrato/farmacias-vallenar-suit/src/actions/operations.ts"],"sourcesContent":["'use server';\n\nimport { query } from '@/lib/db';\nimport { revalidatePath } from 'next/cache';\n\n// --- Shift Management ---\n\nexport async function getShiftStatus() {\n    try {\n        const sql = `SELECT valor FROM configuracion_global WHERE clave = 'en_turno'`;\n        const res = await query(sql);\n        return res.rows.length > 0 ? res.rows[0].valor === 'true' : false;\n    } catch (error) {\n        console.error('Error getting shift status:', error);\n        return false;\n    }\n}\n\nexport async function toggleShift(isOpen: boolean) {\n    try {\n        const sql = `\n            INSERT INTO configuracion_global (clave, valor) \n            VALUES ('en_turno', $1) \n            ON CONFLICT (clave) \n            DO UPDATE SET valor = $1, updated_at = CURRENT_TIMESTAMP\n        `;\n        await query(sql, [String(isOpen)]);\n        revalidatePath('/');\n        return { success: true };\n    } catch (error) {\n        console.error('Error toggling shift:', error);\n        return { success: false, error: 'Failed to update shift status' };\n    }\n}\n\n// --- Time Clock (Asistencia) ---\n\nexport async function clockIn(userId: number) {\n    try {\n        // Check if already clocked in today without clock out\n        const checkSql = `\n            SELECT id FROM asistencia \n            WHERE usuario_id = $1 AND fecha = CURRENT_DATE AND hora_salida IS NULL\n        `;\n        const checkRes = await query(checkSql, [userId]);\n\n        if (checkRes.rows.length > 0) {\n            return { success: false, error: 'Ya has marcado entrada hoy.' };\n        }\n\n        const sql = `\n            INSERT INTO asistencia (usuario_id, fecha, hora_entrada, estado)\n            VALUES ($1, CURRENT_DATE, CURRENT_TIME, 'presente')\n        `;\n        await query(sql, [userId]);\n        revalidatePath('/');\n        return { success: true };\n    } catch (error) {\n        console.error('Error clocking in:', error);\n        return { success: false, error: 'Error al marcar entrada' };\n    }\n}\n\nexport async function clockOut(userId: number) {\n    try {\n        const sql = `\n            UPDATE asistencia \n            SET hora_salida = CURRENT_TIME, estado = 'finalizado'\n            WHERE usuario_id = $1 AND fecha = CURRENT_DATE AND hora_salida IS NULL\n        `;\n        const res = await query(sql, [userId]);\n\n        if (res.rowCount === 0) {\n            return { success: false, error: 'No tienes una entrada activa para marcar salida.' };\n        }\n\n        revalidatePath('/');\n        return { success: true };\n    } catch (error) {\n        console.error('Error clocking out:', error);\n        return { success: false, error: 'Error al marcar salida' };\n    }\n}\n\n// --- Queue System (Totem) ---\n\nexport async function generateTicket(type: 'GENERAL' | 'PREFERENCIAL' | 'CAJA') {\n    try {\n        // 1. Get current number for today\n        const countSql = `SELECT COUNT(*) as count FROM cola_atencion WHERE DATE(created_at) = CURRENT_DATE`;\n        const countRes = await query(countSql);\n        const nextNum = parseInt(countRes.rows[0].count || '0') + 1;\n\n        const prefix = type === 'PREFERENCIAL' ? 'P' : type === 'CAJA' ? 'C' : 'A';\n        const ticketNumber = `${prefix}-${nextNum.toString().padStart(3, '0')}`;\n\n        // 2. Insert ticket\n        const insertSql = `\n            INSERT INTO cola_atencion (numero_ticket, tipo, estado)\n            VALUES ($1, $2, 'espera')\n            RETURNING id, numero_ticket, created_at\n        `;\n        const res = await query(insertSql, [ticketNumber, type]);\n\n        revalidatePath('/totem');\n        return { success: true, ticket: res.rows[0] };\n    } catch (error) {\n        console.error('Error generating ticket:', error);\n        return { success: false, error: 'Error al generar ticket' };\n    }\n}\n\nexport async function getNextTicket(counterId: number) {\n    try {\n        // Find oldest ticket in 'espera'\n        const findSql = `\n            SELECT id, numero_ticket FROM cola_atencion \n            WHERE estado = 'espera' \n            ORDER BY created_at ASC \n            LIMIT 1\n        `;\n        const findRes = await query(findSql);\n\n        if (findRes.rows.length === 0) {\n            return { success: false, message: 'No hay clientes en espera' };\n        }\n\n        const ticket = findRes.rows[0];\n\n        // Update ticket to 'llamando' or 'atendiendo'\n        const updateSql = `\n            UPDATE cola_atencion \n            SET estado = 'llamando', modulo_atencion = $1, updated_at = CURRENT_TIMESTAMP\n            WHERE id = $2\n        `;\n        await query(updateSql, [counterId, ticket.id]);\n\n        revalidatePath('/');\n        return { success: true, ticket };\n    } catch (error) {\n        console.error('Error calling next ticket:', error);\n        return { success: false, error: 'Error al llamar siguiente número' };\n    }\n}\n"],"names":[],"mappings":";;;;;;;IAqCsB,UAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA"}},
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///Users/miguelperdomoserrato/farmacias-vallenar-suit/src/actions/operations.ts"],"sourcesContent":["'use server';\n\nimport { query } from '@/lib/db';\nimport { revalidatePath } from 'next/cache';\n\n// --- Shift Management ---\n\nexport async function getShiftStatus() {\n    try {\n        const sql = `SELECT valor FROM configuracion_global WHERE clave = 'en_turno'`;\n        const res = await query(sql);\n        return res.rows.length > 0 ? res.rows[0].valor === 'true' : false;\n    } catch (error) {\n        console.error('Error getting shift status:', error);\n        return false;\n    }\n}\n\nexport async function toggleShift(isOpen: boolean) {\n    try {\n        const sql = `\n            INSERT INTO configuracion_global (clave, valor) \n            VALUES ('en_turno', $1) \n            ON CONFLICT (clave) \n            DO UPDATE SET valor = $1, updated_at = CURRENT_TIMESTAMP\n        `;\n        await query(sql, [String(isOpen)]);\n        revalidatePath('/');\n        return { success: true };\n    } catch (error) {\n        console.error('Error toggling shift:', error);\n        return { success: false, error: 'Failed to update shift status' };\n    }\n}\n\n// --- Time Clock (Asistencia) ---\n\nexport async function clockIn(userId: number) {\n    try {\n        // Check if already clocked in today without clock out\n        const checkSql = `\n            SELECT id FROM asistencia \n            WHERE usuario_id = $1 AND fecha = CURRENT_DATE AND hora_salida IS NULL\n        `;\n        const checkRes = await query(checkSql, [userId]);\n\n        if (checkRes.rows.length > 0) {\n            return { success: false, error: 'Ya has marcado entrada hoy.' };\n        }\n\n        const sql = `\n            INSERT INTO asistencia (usuario_id, fecha, hora_entrada, estado)\n            VALUES ($1, CURRENT_DATE, CURRENT_TIME, 'presente')\n        `;\n        await query(sql, [userId]);\n        revalidatePath('/');\n        return { success: true };\n    } catch (error) {\n        console.error('Error clocking in:', error);\n        return { success: false, error: 'Error al marcar entrada' };\n    }\n}\n\nexport async function clockOut(userId: number) {\n    try {\n        const sql = `\n            UPDATE asistencia \n            SET hora_salida = CURRENT_TIME, estado = 'finalizado'\n            WHERE usuario_id = $1 AND fecha = CURRENT_DATE AND hora_salida IS NULL\n        `;\n        const res = await query(sql, [userId]);\n\n        if (res.rowCount === 0) {\n            return { success: false, error: 'No tienes una entrada activa para marcar salida.' };\n        }\n\n        revalidatePath('/');\n        return { success: true };\n    } catch (error) {\n        console.error('Error clocking out:', error);\n        return { success: false, error: 'Error al marcar salida' };\n    }\n}\n\n// --- Queue System (Totem) ---\n\nexport async function generateTicket(type: 'GENERAL' | 'PREFERENCIAL' | 'CAJA') {\n    try {\n        // 1. Get current number for today\n        const countSql = `SELECT COUNT(*) as count FROM cola_atencion WHERE DATE(created_at) = CURRENT_DATE`;\n        const countRes = await query(countSql);\n        const nextNum = parseInt(countRes.rows[0].count || '0') + 1;\n\n        const prefix = type === 'PREFERENCIAL' ? 'P' : type === 'CAJA' ? 'C' : 'A';\n        const ticketNumber = `${prefix}-${nextNum.toString().padStart(3, '0')}`;\n\n        // 2. Insert ticket\n        const insertSql = `\n            INSERT INTO cola_atencion (numero_ticket, tipo, estado)\n            VALUES ($1, $2, 'espera')\n            RETURNING id, numero_ticket, created_at\n        `;\n        const res = await query(insertSql, [ticketNumber, type]);\n\n        revalidatePath('/totem');\n        return { success: true, ticket: res.rows[0] };\n    } catch (error) {\n        console.error('Error generating ticket:', error);\n        return { success: false, error: 'Error al generar ticket' };\n    }\n}\n\nexport async function getNextTicket(counterId: number) {\n    try {\n        // Find oldest ticket in 'espera'\n        const findSql = `\n            SELECT id, numero_ticket FROM cola_atencion \n            WHERE estado = 'espera' \n            ORDER BY created_at ASC \n            LIMIT 1\n        `;\n        const findRes = await query(findSql);\n\n        if (findRes.rows.length === 0) {\n            return { success: false, message: 'No hay clientes en espera' };\n        }\n\n        const ticket = findRes.rows[0];\n\n        // Update ticket to 'llamando' or 'atendiendo'\n        const updateSql = `\n            UPDATE cola_atencion \n            SET estado = 'llamando', modulo_atencion = $1, updated_at = CURRENT_TIMESTAMP\n            WHERE id = $2\n        `;\n        await query(updateSql, [counterId, ticket.id]);\n\n        revalidatePath('/');\n        return { success: true, ticket };\n    } catch (error) {\n        console.error('Error calling next ticket:', error);\n        return { success: false, error: 'Error al llamar siguiente número' };\n    }\n}\n"],"names":[],"mappings":";;;;;;;IA+DsB,WAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA"}},
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///Users/miguelperdomoserrato/farmacias-vallenar-suit/src/actions/operations.ts"],"sourcesContent":["'use server';\n\nimport { query } from '@/lib/db';\nimport { revalidatePath } from 'next/cache';\n\n// --- Shift Management ---\n\nexport async function getShiftStatus() {\n    try {\n        const sql = `SELECT valor FROM configuracion_global WHERE clave = 'en_turno'`;\n        const res = await query(sql);\n        return res.rows.length > 0 ? res.rows[0].valor === 'true' : false;\n    } catch (error) {\n        console.error('Error getting shift status:', error);\n        return false;\n    }\n}\n\nexport async function toggleShift(isOpen: boolean) {\n    try {\n        const sql = `\n            INSERT INTO configuracion_global (clave, valor) \n            VALUES ('en_turno', $1) \n            ON CONFLICT (clave) \n            DO UPDATE SET valor = $1, updated_at = CURRENT_TIMESTAMP\n        `;\n        await query(sql, [String(isOpen)]);\n        revalidatePath('/');\n        return { success: true };\n    } catch (error) {\n        console.error('Error toggling shift:', error);\n        return { success: false, error: 'Failed to update shift status' };\n    }\n}\n\n// --- Time Clock (Asistencia) ---\n\nexport async function clockIn(userId: number) {\n    try {\n        // Check if already clocked in today without clock out\n        const checkSql = `\n            SELECT id FROM asistencia \n            WHERE usuario_id = $1 AND fecha = CURRENT_DATE AND hora_salida IS NULL\n        `;\n        const checkRes = await query(checkSql, [userId]);\n\n        if (checkRes.rows.length > 0) {\n            return { success: false, error: 'Ya has marcado entrada hoy.' };\n        }\n\n        const sql = `\n            INSERT INTO asistencia (usuario_id, fecha, hora_entrada, estado)\n            VALUES ($1, CURRENT_DATE, CURRENT_TIME, 'presente')\n        `;\n        await query(sql, [userId]);\n        revalidatePath('/');\n        return { success: true };\n    } catch (error) {\n        console.error('Error clocking in:', error);\n        return { success: false, error: 'Error al marcar entrada' };\n    }\n}\n\nexport async function clockOut(userId: number) {\n    try {\n        const sql = `\n            UPDATE asistencia \n            SET hora_salida = CURRENT_TIME, estado = 'finalizado'\n            WHERE usuario_id = $1 AND fecha = CURRENT_DATE AND hora_salida IS NULL\n        `;\n        const res = await query(sql, [userId]);\n\n        if (res.rowCount === 0) {\n            return { success: false, error: 'No tienes una entrada activa para marcar salida.' };\n        }\n\n        revalidatePath('/');\n        return { success: true };\n    } catch (error) {\n        console.error('Error clocking out:', error);\n        return { success: false, error: 'Error al marcar salida' };\n    }\n}\n\n// --- Queue System (Totem) ---\n\nexport async function generateTicket(type: 'GENERAL' | 'PREFERENCIAL' | 'CAJA') {\n    try {\n        // 1. Get current number for today\n        const countSql = `SELECT COUNT(*) as count FROM cola_atencion WHERE DATE(created_at) = CURRENT_DATE`;\n        const countRes = await query(countSql);\n        const nextNum = parseInt(countRes.rows[0].count || '0') + 1;\n\n        const prefix = type === 'PREFERENCIAL' ? 'P' : type === 'CAJA' ? 'C' : 'A';\n        const ticketNumber = `${prefix}-${nextNum.toString().padStart(3, '0')}`;\n\n        // 2. Insert ticket\n        const insertSql = `\n            INSERT INTO cola_atencion (numero_ticket, tipo, estado)\n            VALUES ($1, $2, 'espera')\n            RETURNING id, numero_ticket, created_at\n        `;\n        const res = await query(insertSql, [ticketNumber, type]);\n\n        revalidatePath('/totem');\n        return { success: true, ticket: res.rows[0] };\n    } catch (error) {\n        console.error('Error generating ticket:', error);\n        return { success: false, error: 'Error al generar ticket' };\n    }\n}\n\nexport async function getNextTicket(counterId: number) {\n    try {\n        // Find oldest ticket in 'espera'\n        const findSql = `\n            SELECT id, numero_ticket FROM cola_atencion \n            WHERE estado = 'espera' \n            ORDER BY created_at ASC \n            LIMIT 1\n        `;\n        const findRes = await query(findSql);\n\n        if (findRes.rows.length === 0) {\n            return { success: false, message: 'No hay clientes en espera' };\n        }\n\n        const ticket = findRes.rows[0];\n\n        // Update ticket to 'llamando' or 'atendiendo'\n        const updateSql = `\n            UPDATE cola_atencion \n            SET estado = 'llamando', modulo_atencion = $1, updated_at = CURRENT_TIMESTAMP\n            WHERE id = $2\n        `;\n        await query(updateSql, [counterId, ticket.id]);\n\n        revalidatePath('/');\n        return { success: true, ticket };\n    } catch (error) {\n        console.error('Error calling next ticket:', error);\n        return { success: false, error: 'Error al llamar siguiente número' };\n    }\n}\n"],"names":[],"mappings":";;;;;;;IAsFsB,iBAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA"}},
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///Users/miguelperdomoserrato/farmacias-vallenar-suit/src/actions/operations.ts"],"sourcesContent":["'use server';\n\nimport { query } from '@/lib/db';\nimport { revalidatePath } from 'next/cache';\n\n// --- Shift Management ---\n\nexport async function getShiftStatus() {\n    try {\n        const sql = `SELECT valor FROM configuracion_global WHERE clave = 'en_turno'`;\n        const res = await query(sql);\n        return res.rows.length > 0 ? res.rows[0].valor === 'true' : false;\n    } catch (error) {\n        console.error('Error getting shift status:', error);\n        return false;\n    }\n}\n\nexport async function toggleShift(isOpen: boolean) {\n    try {\n        const sql = `\n            INSERT INTO configuracion_global (clave, valor) \n            VALUES ('en_turno', $1) \n            ON CONFLICT (clave) \n            DO UPDATE SET valor = $1, updated_at = CURRENT_TIMESTAMP\n        `;\n        await query(sql, [String(isOpen)]);\n        revalidatePath('/');\n        return { success: true };\n    } catch (error) {\n        console.error('Error toggling shift:', error);\n        return { success: false, error: 'Failed to update shift status' };\n    }\n}\n\n// --- Time Clock (Asistencia) ---\n\nexport async function clockIn(userId: number) {\n    try {\n        // Check if already clocked in today without clock out\n        const checkSql = `\n            SELECT id FROM asistencia \n            WHERE usuario_id = $1 AND fecha = CURRENT_DATE AND hora_salida IS NULL\n        `;\n        const checkRes = await query(checkSql, [userId]);\n\n        if (checkRes.rows.length > 0) {\n            return { success: false, error: 'Ya has marcado entrada hoy.' };\n        }\n\n        const sql = `\n            INSERT INTO asistencia (usuario_id, fecha, hora_entrada, estado)\n            VALUES ($1, CURRENT_DATE, CURRENT_TIME, 'presente')\n        `;\n        await query(sql, [userId]);\n        revalidatePath('/');\n        return { success: true };\n    } catch (error) {\n        console.error('Error clocking in:', error);\n        return { success: false, error: 'Error al marcar entrada' };\n    }\n}\n\nexport async function clockOut(userId: number) {\n    try {\n        const sql = `\n            UPDATE asistencia \n            SET hora_salida = CURRENT_TIME, estado = 'finalizado'\n            WHERE usuario_id = $1 AND fecha = CURRENT_DATE AND hora_salida IS NULL\n        `;\n        const res = await query(sql, [userId]);\n\n        if (res.rowCount === 0) {\n            return { success: false, error: 'No tienes una entrada activa para marcar salida.' };\n        }\n\n        revalidatePath('/');\n        return { success: true };\n    } catch (error) {\n        console.error('Error clocking out:', error);\n        return { success: false, error: 'Error al marcar salida' };\n    }\n}\n\n// --- Queue System (Totem) ---\n\nexport async function generateTicket(type: 'GENERAL' | 'PREFERENCIAL' | 'CAJA') {\n    try {\n        // 1. Get current number for today\n        const countSql = `SELECT COUNT(*) as count FROM cola_atencion WHERE DATE(created_at) = CURRENT_DATE`;\n        const countRes = await query(countSql);\n        const nextNum = parseInt(countRes.rows[0].count || '0') + 1;\n\n        const prefix = type === 'PREFERENCIAL' ? 'P' : type === 'CAJA' ? 'C' : 'A';\n        const ticketNumber = `${prefix}-${nextNum.toString().padStart(3, '0')}`;\n\n        // 2. Insert ticket\n        const insertSql = `\n            INSERT INTO cola_atencion (numero_ticket, tipo, estado)\n            VALUES ($1, $2, 'espera')\n            RETURNING id, numero_ticket, created_at\n        `;\n        const res = await query(insertSql, [ticketNumber, type]);\n\n        revalidatePath('/totem');\n        return { success: true, ticket: res.rows[0] };\n    } catch (error) {\n        console.error('Error generating ticket:', error);\n        return { success: false, error: 'Error al generar ticket' };\n    }\n}\n\nexport async function getNextTicket(counterId: number) {\n    try {\n        // Find oldest ticket in 'espera'\n        const findSql = `\n            SELECT id, numero_ticket FROM cola_atencion \n            WHERE estado = 'espera' \n            ORDER BY created_at ASC \n            LIMIT 1\n        `;\n        const findRes = await query(findSql);\n\n        if (findRes.rows.length === 0) {\n            return { success: false, message: 'No hay clientes en espera' };\n        }\n\n        const ticket = findRes.rows[0];\n\n        // Update ticket to 'llamando' or 'atendiendo'\n        const updateSql = `\n            UPDATE cola_atencion \n            SET estado = 'llamando', modulo_atencion = $1, updated_at = CURRENT_TIMESTAMP\n            WHERE id = $2\n        `;\n        await query(updateSql, [counterId, ticket.id]);\n\n        revalidatePath('/');\n        return { success: true, ticket };\n    } catch (error) {\n        console.error('Error calling next ticket:', error);\n        return { success: false, error: 'Error al llamar siguiente número' };\n    }\n}\n"],"names":[],"mappings":";;;;;;;IAgHsB,gBAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA"}}]
}