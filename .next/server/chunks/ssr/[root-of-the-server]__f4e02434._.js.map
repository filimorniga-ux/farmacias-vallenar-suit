{"version":3,"sources":["../../../../src/components/auth/RouteGuard.tsx/__nextjs-internal-proxy.mjs","../../../../src/lib/db.ts","../../../../node_modules/next/src/build/webpack/loaders/next-flight-loader/server-reference.ts","../../../../node_modules/next/src/build/webpack/loaders/next-flight-loader/action-validate.ts","../../../../src/lib/logger.ts","../../../../src/actions/logger-action.ts","../../../../src/lib/data/supply.ts","../../../../src/components/supply/RestockingTable.tsx/__nextjs-internal-proxy.mjs","../../../../src/components/supply/ReceptionForm.tsx/__nextjs-internal-proxy.mjs","../../../../src/app/proveedores/page.tsx","../../../../.next-internal/server/app/proveedores/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/components/auth/RouteGuard.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/components/auth/RouteGuard.tsx\",\n    \"default\",\n);\n","import { Pool } from 'pg';\n\n// Disable SSL verification for self-signed certs in development\nif (process.env.NODE_ENV !== 'production') {\n    process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';\n}\n\nconst pool = new Pool({\n    // La conexi√≥n se sigue leyendo de la variable DATABASE_URL\n    connectionString: process.env.DATABASE_URL,\n    // [PARCHE CR√çTICO PARA EL ENTORNO LOCAL]\n    ssl: {\n        rejectUnauthorized: false,\n    },\n});\n\nexport async function query(text: string, params?: any[]) {\n    const start = Date.now();\n    const res = await pool.query(text, params);\n    const duration = Date.now() - start;\n    console.log('Executed query', { text, duration, rows: res.rowCount });\n    return res;\n}\n\nexport default pool;\n","/* eslint-disable import/no-extraneous-dependencies */\nexport { registerServerReference } from 'react-server-dom-webpack/server'\n","// This function ensures that all the exported values are valid server actions,\n// during the runtime. By definition all actions are required to be async\n// functions, but here we can only check that they are functions.\nexport function ensureServerEntryExports(actions: any[]) {\n  for (let i = 0; i < actions.length; i++) {\n    const action = actions[i]\n    if (typeof action !== 'function') {\n      throw new Error(\n        `A \"use server\" file can only export async functions, found ${typeof action}.\\nRead more: https://nextjs.org/docs/messages/invalid-use-server-value`\n      )\n    }\n  }\n}\n","import { query } from '@/lib/db';\n\nexport async function logAction(usuario: string, accion: string, detalle: string) {\n    try {\n        const sql = `\n            INSERT INTO audit_logs (usuario, accion, detalle)\n            VALUES ($1, $2, $3)\n        `;\n        await query(sql, [usuario, accion, detalle]);\n    } catch (error) {\n        console.error('Error logging action:', error);\n        // We don't want to crash the app if logging fails, so we just log the error to console\n    }\n}\n","'use server';\n\nimport { logAction as logToDb } from '@/lib/logger';\n\nexport async function logActionServer(usuario: string, accion: string, detalle: string) {\n    await logToDb(usuario, accion, detalle);\n}\n","import { query } from '@/lib/db';\n\nexport interface ProductSimple {\n    id: number;\n    nombre: string;\n}\n\nexport async function getProducts(): Promise<ProductSimple[]> {\n    try {\n        const res = await query('SELECT id, nombre FROM productos WHERE activo = true ORDER BY nombre ASC');\n        return res.rows;\n    } catch (error) {\n        console.error('Error fetching products:', error);\n        return [];\n    }\n}\n\nexport interface Supplier {\n    id: number;\n    nombre_fantasia: string;\n    rut: string;\n    contacto_email: string;\n    telefono: string;\n}\n\nexport interface RestockingItem {\n    producto_id: number;\n    nombre: string;\n    stock_actual: number;\n    stock_minimo: number;\n    sugerencia_pedido: number;\n    proveedor_sugerido?: string;\n}\n\nexport async function getSuppliers(): Promise<Supplier[]> {\n    try {\n        const res = await query('SELECT * FROM proveedores ORDER BY nombre_fantasia ASC');\n        return res.rows;\n    } catch (error) {\n        console.error('Error fetching suppliers:', error);\n        return [];\n    }\n}\n\nexport async function getRestockingSuggestions(): Promise<RestockingItem[]> {\n    try {\n        // 1. Get products with their total stock (sum of lots)\n        // We use COALESCE to handle products with no lots (stock 0)\n        const sql = `\n      SELECT \n        p.id as producto_id,\n        p.nombre,\n        p.stock_minimo_seguridad,\n        COALESCE(SUM(l.cantidad_disponible), 0) as stock_actual\n      FROM productos p\n      LEFT JOIN lotes l ON p.id = l.producto_id\n      WHERE p.activo = true\n      GROUP BY p.id, p.nombre, p.stock_minimo_seguridad\n    `;\n\n        const res = await query(sql);\n\n        const suggestions: RestockingItem[] = [];\n\n        res.rows.forEach((row: any) => {\n            const stockActual = Number(row.stock_actual);\n            const stockMinimo = Number(row.stock_minimo_seguridad) || 10; // Default 10 if null\n\n            if (stockActual <= stockMinimo) {\n                // Formula: (Min * 3) - Actual\n                let sugerencia = (stockMinimo * 3) - stockActual;\n                if (sugerencia < 0) sugerencia = 0;\n\n                if (sugerencia > 0) {\n                    suggestions.push({\n                        producto_id: row.producto_id,\n                        nombre: row.nombre,\n                        stock_actual: stockActual,\n                        stock_minimo: stockMinimo,\n                        sugerencia_pedido: sugerencia,\n                        proveedor_sugerido: 'Laboratorio Chile' // Mock default, could be dynamic\n                    });\n                }\n            }\n        });\n\n        return suggestions.sort((a, b) => a.stock_actual - b.stock_actual); // Most critical first\n    } catch (error) {\n        console.error('Error calculating restocking suggestions:', error);\n        return [];\n    }\n}\n\nexport async function receiveProduct(data: {\n    producto_id: number;\n    numero_lote: string;\n    fecha_vencimiento: string;\n    cantidad: number;\n    ubicacion_fisica?: string;\n}) {\n    const sql = `\n    INSERT INTO lotes (producto_id, numero_lote, fecha_vencimiento, cantidad_disponible, ubicacion_fisica)\n    VALUES ($1, $2, $3, $4, $5)\n    RETURNING id\n  `;\n    const params = [\n        data.producto_id,\n        data.numero_lote,\n        data.fecha_vencimiento,\n        data.cantidad,\n        data.ubicacion_fisica || 'Bodega Central'\n    ];\n\n    return await query(sql, params);\n}\n","// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/components/supply/RestockingTable.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/components/supply/RestockingTable.tsx\",\n    \"default\",\n);\n","// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/components/supply/ReceptionForm.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/components/supply/ReceptionForm.tsx\",\n    \"default\",\n);\n","import { getSuppliers, getRestockingSuggestions, getProducts } from '@/lib/data/supply';\nimport RestockingTable from '@/components/supply/RestockingTable';\nimport ReceptionForm from '@/components/supply/ReceptionForm';\nimport RouteGuard from '@/components/auth/RouteGuard';\n\nexport const dynamic = 'force-dynamic';\n\nexport default async function ProveedoresPage() {\n    const suppliers = await getSuppliers();\n    const suggestions = await getRestockingSuggestions();\n    const products = await getProducts();\n\n    return (\n        <RouteGuard allowedRoles={['ADMIN', 'QF']}>\n            <div className=\"min-h-screen bg-gray-100 py-8\">\n                <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\n                    <div className=\"md:flex md:items-center md:justify-between mb-8\">\n                        <div className=\"min-w-0 flex-1\">\n                            <h2 className=\"text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight\">\n                                üöö Abastecimiento\n                            </h2>\n                            <p className=\"mt-1 text-sm text-gray-500\">\n                                Gesti√≥n de proveedores y reposici√≥n inteligente.\n                            </p>\n                        </div>\n                        <div className=\"mt-4 flex md:ml-4 md:mt-0\">\n                            <form action={async () => {\n                                'use server';\n                                const { logActionServer } = await import('@/actions/logger-action');\n                                await logActionServer('admin', 'AJUSTE_STOCK', 'Ajuste manual de stock simulado: Paracetamol -10');\n                            }}>\n                                <button\n                                    type=\"submit\"\n                                    className=\"ml-3 inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50\"\n                                >\n                                    Simular Ajuste Stock\n                                </button>\n                            </form>\n                        </div>\n                    </div>\n\n                    <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8\">\n                        {/* Left Column: Restocking Suggestions (2/3 width) */}\n                        <div className=\"lg:col-span-2 space-y-6\">\n                            <div className=\"bg-white shadow sm:rounded-lg p-6\">\n                                <h3 className=\"text-lg font-medium leading-6 text-gray-900 mb-4\">\n                                    Alertas de Stock\n                                </h3>\n                                <RestockingTable suggestions={suggestions} />\n                            </div>\n                        </div>\n\n                        {/* Right Column: Reception Form (1/3 width) */}\n                        <div className=\"lg:col-span-1\">\n                            <ReceptionForm suppliers={suppliers} products={products} />\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </RouteGuard>\n    );\n}\n","export {$$RSC_SERVER_ACTION_0 as '00e00ff649a3c28d13f68be9addfd3ca593e7d7e05'} from 'ACTIONS_MODULE0'\nexport {logActionServer as '70610f9480cb8076820485f1c0bd0020dae47b9cb9'} from 'ACTIONS_MODULE1'\n"],"names":["registerServerReference","ensureServerEntryExports","actions","i","length","action","Error"],"mappings":"6CAEe,CAAA,EAAA,AADf,EAAA,CAAA,CAAA,OACe,uBAAA,AAAuB,EAClC,WAAa,MAAM,AAAI,MAAM,oSAAsS,EACnU,mEACA,8DAHW,CAAA,EADf,AACe,EADf,CAAA,CAAA,OACe,uBAAA,AAAuB,EAClC,WAAa,MAAM,AAAI,MAAM,gRAAkR,EAC/S,+CACA,6MCLJ,IAAA,EAAA,EAAA,CAAA,CAAA,yCAOA,IAAM,EAAO,IAAI,EAAA,IAAI,CAAC,CAElB,iBAAkB,QAAQ,GAAG,CAAC,YAAY,CAE1C,IAAK,CACD,oBAAoB,CACxB,CACJ,GAEO,eAAe,EAAM,CAAY,CAAE,CAAc,EACpD,IAAM,EAAQ,KAAK,GAAG,GAChB,EAAM,MAAM,EAAK,KAAK,CAAC,EAAM,GAC7B,EAAW,KAAK,GAAG,GAAK,EAE9B,OADA,QAAQ,GAAG,CAAC,iBAAkB,MAAE,WAAM,EAAU,KAAM,EAAI,QAAQ,AAAC,GAC5D,CACX,2ECtBoD,OAAA,cAAA,CAAA,EAAA,aAAA,oCAC3CA,0BAAAA,qCAAAA,EAAAA,uBAAuB,YAAQ,CAAA,CAAA,IAAA,iCCEjC,SAASC,EAAyBC,CAAc,EACrD,IAAK,IAAIC,EAAI,EAAGA,EAAID,EAAQE,MAAM,CAAED,IAAK,CACvC,IAAME,EAASH,CAAO,CAACC,EAAE,CACzB,GAAsB,YAAlB,AAA8B,OAAvBE,EACT,MAAM,OAAA,cAEL,CAFK,AAAIC,MACR,CAAC,2DAA2D,EAAE,OAAOD,EAAO;AAAA,oEAAuE,CAAC,EADhJ,oBAAA,OAAA,kBAAA,iBAAA,CAEN,EAEJ,CACF,0EATgBJ,2BAAAA,qCAAAA,oCCHhB,IAAA,EAAA,EAAA,CAAA,CAAA,gBAEO,eAAe,EAAU,CAAe,CAAE,CAAc,CAAE,CAAe,EAC5E,GAAI,CACA,IAAM,EAAM,CAAC;;;QAGb,CAAC,AACD,OAAM,CAAA,EAAA,EAAA,KAAA,AAAK,EAAC,EAAK,CAAC,EAAS,EAAQ,EAAQ,CAC/C,CAAE,MAAO,EAAO,CACZ,QAAQ,KAAK,CAAC,wBAAyB,EAE3C,CACJ,0HCXA,EAAA,EAAA,CAAA,CAAA,6BAEO,eAAe,EAAgB,CAAe,CAAE,CAAc,CAAE,CAAe,EAClF,MAAM,CAAA,EAAA,EAAA,SAAA,AAAO,EAAC,EAAS,EAAQ,EACnC,0DAFsB,IAAA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,2FCJtB,IAAA,EAAA,EAAA,CAAA,CAAA,gBAOO,eAAe,IAClB,GAAI,CAEA,MAAO,CADK,MAAM,CAAA,EAAA,EAAA,KAAA,AAAK,EAAC,2EAAA,EACb,IAAI,AACnB,CAAE,MAAO,EAAO,CAEZ,OADA,QAAQ,KAAK,CAAC,2BAA4B,GACnC,EAAE,AACb,CACJ,CAmBO,eAAe,IAClB,GAAI,CAEA,MADY,AACL,OADW,CAAA,EAAA,EAAA,KAAA,AAAK,EAAC,yDAAA,EACb,IAAI,AACnB,CAAE,MAAO,EAAO,CAEZ,OADA,QAAQ,KAAK,CAAC,4BAA6B,GACpC,EAAE,AACb,CACJ,CAEO,eAAe,IAClB,GAAI,CAGA,IAAM,EAAM,CAAC;;;;;;;;;;IAUjB,CAAC,CAES,EAAM,MAAM,CAAA,EAAA,EAAA,KAAA,AAAK,EAAC,GAElB,EAAgC,EAAE,CAwBxC,OAtBA,EAAI,IAAI,CAAC,OAAO,CAAC,AAAC,IACd,IAAM,EAAc,OAAO,EAAI,YAAY,EACrC,EAAc,OAAO,EAAI,sBAAsB,GAAK,GAE1D,CAF8D,EAE1D,GAAe,EAAa,CAE5B,IAAI,EAA4B,AAAd,IAAmB,EACjC,CAL2E,CAK9D,IAAG,GAAa,EAE7B,EAAa,GAAG,AAChB,EAAY,IAAI,CAAC,CACb,YAAa,EAAI,WAAW,CAC5B,OAAQ,EAAI,MAAM,CAClB,aAAc,EACd,aAAc,EACd,kBAAmB,EACnB,mBAAoB,mBACxB,CAD4C,CAGpD,CACJ,GAEO,EAAY,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,YAAY,AANyC,CAMtC,EAAE,YAAY,CACrE,CAAE,CADsE,KAC/D,EAAO,CAEZ,OADA,OAF0F,CAElF,KAAK,CAAC,4CAA6C,GACpD,EAAE,AACb,CACJ,gKCzFe,CAAA,EADf,AACe,EADf,CAAA,CAAA,OACe,uBAAA,AAAuB,EAClC,WAAa,MAAM,AAAI,MAAM,2SAA6S,EAC1U,0EACA,6DAHW,CAAA,EAAA,AADf,EAAA,CAAA,CAAA,OACe,uBAAA,AAAuB,EAClC,WAAa,MAAM,AAAI,MAAM,uRAAyR,EACtT,sDACA,wHCHW,CAAA,EADf,AACe,EADf,CAAA,CAAA,OACe,uBAAA,AAAuB,EAClC,WAAa,MAAM,AAAI,MAAM,ySAA2S,EACxU,wEACA,8DAHW,CAAA,EADf,AACe,EADf,CAAA,CAAA,OACe,uBAAA,AAAuB,EAClC,WAAa,MAAM,AAAI,MAAM,qRAAuR,EACpT,oDACA,uJCLJ,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,6CAuB0C,EAAA,eAAR,EAEF,GAAM,iBAAE,CAAe,CAAE,CAAG,MAAA,EAAA,CAAA,CAAA,MAC5B,OAAM,EAAgB,QAAS,eAAgB,mDACnD,EAvBb,eAAe,IAC1B,IAAM,EAAY,MAAM,CAAA,EAAA,EAAA,YAAY,AAAZ,IAClB,EAAc,MAAM,CAAA,EAAA,EAAA,wBAAA,AAAwB,IAC5C,EAAW,MAAM,CAAA,EAAA,EAAA,WAAA,AAAW,IAElC,MACI,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,OAAU,CAAA,CAAC,aAAc,CAAC,QAAS,KAAK,UACrC,CAAA,EAAA,EAAA,GAAA,EAAC,MAAA,CAAI,UAAU,yCACX,CAAA,EAAA,EAAA,IAAA,EAAC,MAAA,CAAI,UAAU,mDACX,CAAA,EAAA,EAAA,IAAA,EAAC,MAAA,CAAI,UAAU,4DACX,CAAA,EAAA,EAAA,IAAA,EAAC,MAAA,CAAI,UAAU,2BACX,CAAA,EAAA,EAAA,GAAA,EAAC,KAAA,CAAG,UAAU,gGAAuF,sBAGrG,CAAA,EAAA,EAAA,GAAA,EAAC,IAAA,CAAE,UAAU,sCAA6B,wDAI9C,CAAA,EAAA,EAAA,GAAA,EAAC,MAAA,CAAI,UAAU,qCACX,CAAA,EAAA,EAAA,GAAA,EAAC,OAAA,CAAK,OAAQ,WAKV,CAAA,EAAA,EAAA,GAAA,EAAC,SAAA,CACG,KAAK,SACL,UAAU,sKACb,gCAOb,CAAA,EAAA,EAAA,IAAA,EAAC,MAAA,CAAI,UAAU,kDAEX,CAAA,EAAA,EAAA,GAAA,EAAC,MAAA,CAAI,UAAU,mCACX,CAAA,EAAA,EAAA,IAAA,EAAC,MAAA,CAAI,UAAU,8CACX,CAAA,EAAA,EAAA,GAAA,EAAC,KAAA,CAAG,UAAU,4DAAmD,qBAGjE,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,OAAe,CAAA,CAAC,YAAa,SAKtC,CAAA,EAAA,EAAA,GAAA,EAAC,MAAA,CAAI,UAAU,yBACX,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,OAAa,CAAA,CAAC,UAAW,EAAW,SAAU,eAO3E,CAnC0C,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,mEArBnB,wECLvB,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA","ignoreList":[0,2,3,7,8]}