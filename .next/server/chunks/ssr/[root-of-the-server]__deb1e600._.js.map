{"version":3,"sources":["../../../../src/lib/db.ts","../../../../node_modules/next/src/build/webpack/loaders/next-flight-loader/server-reference.ts","../../../../node_modules/next/src/build/webpack/loaders/next-flight-loader/action-validate.ts","../../../../src/actions/sync.ts","../../../../.next-internal/server/app/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["import { Pool } from 'pg';\n\n// Disable SSL verification for self-signed certs in development\nif (process.env.NODE_ENV !== 'production') {\n    process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';\n}\n\nconst pool = new Pool({\n    // La conexión se sigue leyendo de la variable DATABASE_URL\n    connectionString: process.env.DATABASE_URL,\n    // [PARCHE CRÍTICO PARA EL ENTORNO LOCAL]\n    ssl: {\n        rejectUnauthorized: false,\n    },\n});\n\n// Handle idle client errors to prevent crash\npool.on('error', (err, client) => {\n    console.error('Unexpected error on idle client', err);\n    // Don't exit the process, just log it\n});\n\nexport async function query(text: string, params?: any[]) {\n    const start = Date.now();\n    try {\n        const res = await pool.query(text, params);\n        const duration = Date.now() - start;\n        console.log('Executed query', { text, duration, rows: res.rowCount });\n        return res;\n    } catch (error) {\n        console.warn('⚠️ Safe Mode: Database connection failed. Returning empty data.');\n        // console.error('Database Error:', error); // Uncomment for debugging\n        // Return a safe mock object to prevent app crash\n        return {\n            rows: [],\n            rowCount: 0,\n            command: '',\n            oid: 0,\n            fields: []\n        };\n    }\n}\n\nexport default pool;\n","/* eslint-disable import/no-extraneous-dependencies */\nexport { registerServerReference } from 'react-server-dom-webpack/server'\n","// This function ensures that all the exported values are valid server actions,\n// during the runtime. By definition all actions are required to be async\n// functions, but here we can only check that they are functions.\nexport function ensureServerEntryExports(actions: any[]) {\n  for (let i = 0; i < actions.length; i++) {\n    const action = actions[i]\n    if (typeof action !== 'function') {\n      throw new Error(\n        `A \"use server\" file can only export async functions, found ${typeof action}.\\nRead more: https://nextjs.org/docs/messages/invalid-use-server-value`\n      )\n    }\n  }\n}\n","'use server';\n\nimport { query } from '../lib/db';\nimport { InventoryBatch, EmployeeProfile } from '../domain/types';\n\nexport async function fetchInventory(): Promise<InventoryBatch[]> {\n    try {\n        const res = await query('SELECT * FROM productos');\n\n        // Map DB columns to Domain Type\n        // Assuming DB columns might be snake_case or slightly different. \n        // We map what we can and default the rest for safety.\n        return res.rows.map((row: any) => ({\n            id: row.id?.toString() || `PROD-${Math.random()}`,\n            sku: row.sku || row.codigo || 'UNKNOWN',\n            name: row.nombre || row.name || 'Sin Nombre',\n            dci: row.dci || row.principio_activo || '',\n            laboratory: row.laboratory || row.laboratorio || 'GENERICO',\n            isp_register: row.isp_register || row.registro_isp || '',\n            format: row.format || row.formato || 'CAJA',\n            units_per_box: Number(row.units_per_box || row.unidades_por_caja) || 1,\n            is_bioequivalent: row.is_bioequivalent || row.es_bioequivalente || false,\n\n            // Legacy / Optional / Derived defaults\n            concentration: row.concentration || '',\n            unit_count: Number(row.unit_count) || 1,\n            is_generic: row.is_generic || false,\n            bioequivalent_status: (row.bioequivalent_status || 'NO_BIOEQUIVALENTE') as any,\n\n            // Financials\n            cost_net: Number(row.cost_net || row.costo_neto) || 0,\n            tax_percent: Number(row.tax_percent || row.iva) || 19,\n            price_sell_box: Number(row.price_sell_box || row.precio_venta_caja) || Number(row.price || row.precio) || 0,\n            price_sell_unit: Number(row.price_sell_unit || row.precio_venta_unitario) || 0,\n\n            // Legacy Mapped\n            price: Number(row.price || row.precio) || 0,\n            cost_price: Number(row.cost_price) || 0,\n\n            // Logistics\n            stock_actual: Number(row.stock_actual || row.stock) || 0,\n            stock_min: Number(row.stock_min || row.stock_min) || 5,\n            stock_max: Number(row.stock_max) || 100,\n            expiry_date: row.vencimiento ? new Date(row.vencimiento).getTime() : Date.now() + 31536000000,\n            location_id: row.location_id || 'BODEGA_CENTRAL',\n\n            category: (row.category || row.categoria) as any,\n            condition: (row.sale_condition || row.condicion_venta) as any,\n            allows_commission: row.allows_commission || row.permite_comision || false,\n            active_ingredients: row.active_ingredients || row.principios_activos ? (Array.isArray(row.principios_activos) ? row.principios_activos : [row.principios_activos]) : [],\n            supplier_id: row.supplier_id || row.proveedor_id || 'SUP-001'\n        }));\n    } catch (error) {\n        console.error('Error fetching inventory:', error);\n        return [];\n    }\n}\n\nexport async function fetchEmployees(): Promise<EmployeeProfile[]> {\n    try {\n        const res = await query('SELECT * FROM users');\n\n        return res.rows.map((row: any) => ({\n            id: row.id?.toString() || `EMP-${Math.random()}`,\n            rut: row.rut || 'SIN-RUT',\n            name: row.name || 'Usuario Sistema',\n            role: row.role || 'CASHIER',\n            access_pin: row.pin || '0000',\n            status: row.status || 'ACTIVE',\n            current_status: 'OUT',\n            job_title: 'CAJERO_VENDEDOR', // Default for sync\n            labor_data: {\n                base_salary: 500000,\n                afp: 'MODELO',\n                isapre: 'FONASA',\n                contract_hours: 45\n            }\n        }));\n    } catch (error) {\n        console.error('Error fetching employees:', error);\n        return [];\n    }\n}\n","export {fetchInventory as '00c615738dee04c926eae6a477946663d417070cbe'} from 'ACTIONS_MODULE0'\nexport {fetchEmployees as '00d0672270153964780a8329ffe4e1f0f604b77dd0'} from 'ACTIONS_MODULE0'\n"],"names":["registerServerReference","ensureServerEntryExports","actions","i","length","action","Error"],"mappings":"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","ignoreList":[1,2]}