{"version":3,"sources":["../../../../src/lib/db.ts","../../../../src/components/auth/RouteGuard.tsx/__nextjs-internal-proxy.mjs","../../../../src/lib/data/supply.ts","../../../../src/components/supply/RestockingTable.tsx/__nextjs-internal-proxy.mjs","../../../../src/components/supply/ReceptionForm.tsx/__nextjs-internal-proxy.mjs","../../../../src/app/proveedores/page.tsx"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n    connectionString: process.env.DATABASE_URL,\n    ssl:\n        process.env.NODE_ENV === 'production'\n            ? { rejectUnauthorized: false }\n            : false,\n});\n\nexport async function query(text: string, params?: any[]) {\n    const start = Date.now();\n    const res = await pool.query(text, params);\n    const duration = Date.now() - start;\n    console.log('Executed query', { text, duration, rows: res.rowCount });\n    return res;\n}\n\nexport default pool;\n","// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/components/auth/RouteGuard.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/components/auth/RouteGuard.tsx\",\n    \"default\",\n);\n","import { query } from '@/lib/db';\n\nexport interface ProductSimple {\n    id: number;\n    nombre: string;\n}\n\nexport async function getProducts(): Promise<ProductSimple[]> {\n    try {\n        const res = await query('SELECT id, nombre FROM productos WHERE activo = true ORDER BY nombre ASC');\n        return res.rows;\n    } catch (error) {\n        console.error('Error fetching products:', error);\n        return [];\n    }\n}\n\nexport interface Supplier {\n    id: number;\n    nombre_fantasia: string;\n    rut: string;\n    contacto_email: string;\n    telefono: string;\n}\n\nexport interface RestockingItem {\n    producto_id: number;\n    nombre: string;\n    stock_actual: number;\n    stock_minimo: number;\n    sugerencia_pedido: number;\n    proveedor_sugerido?: string;\n}\n\nexport async function getSuppliers(): Promise<Supplier[]> {\n    try {\n        const res = await query('SELECT * FROM proveedores ORDER BY nombre_fantasia ASC');\n        return res.rows;\n    } catch (error) {\n        console.error('Error fetching suppliers:', error);\n        return [];\n    }\n}\n\nexport async function getRestockingSuggestions(): Promise<RestockingItem[]> {\n    try {\n        // 1. Get products with their total stock (sum of lots)\n        // We use COALESCE to handle products with no lots (stock 0)\n        const sql = `\n      SELECT \n        p.id as producto_id,\n        p.nombre,\n        p.stock_minimo_seguridad,\n        COALESCE(SUM(l.cantidad_disponible), 0) as stock_actual\n      FROM productos p\n      LEFT JOIN lotes l ON p.id = l.producto_id\n      WHERE p.activo = true\n      GROUP BY p.id, p.nombre, p.stock_minimo_seguridad\n    `;\n\n        const res = await query(sql);\n\n        const suggestions: RestockingItem[] = [];\n\n        res.rows.forEach((row: any) => {\n            const stockActual = Number(row.stock_actual);\n            const stockMinimo = Number(row.stock_minimo_seguridad) || 10; // Default 10 if null\n\n            if (stockActual <= stockMinimo) {\n                // Formula: (Min * 3) - Actual\n                let sugerencia = (stockMinimo * 3) - stockActual;\n                if (sugerencia < 0) sugerencia = 0;\n\n                if (sugerencia > 0) {\n                    suggestions.push({\n                        producto_id: row.producto_id,\n                        nombre: row.nombre,\n                        stock_actual: stockActual,\n                        stock_minimo: stockMinimo,\n                        sugerencia_pedido: sugerencia,\n                        proveedor_sugerido: 'Laboratorio Chile' // Mock default, could be dynamic\n                    });\n                }\n            }\n        });\n\n        return suggestions.sort((a, b) => a.stock_actual - b.stock_actual); // Most critical first\n    } catch (error) {\n        console.error('Error calculating restocking suggestions:', error);\n        return [];\n    }\n}\n\nexport async function receiveProduct(data: {\n    producto_id: number;\n    numero_lote: string;\n    fecha_vencimiento: string;\n    cantidad: number;\n    ubicacion_fisica?: string;\n}) {\n    const sql = `\n    INSERT INTO lotes (producto_id, numero_lote, fecha_vencimiento, cantidad_disponible, ubicacion_fisica)\n    VALUES ($1, $2, $3, $4, $5)\n    RETURNING id\n  `;\n    const params = [\n        data.producto_id,\n        data.numero_lote,\n        data.fecha_vencimiento,\n        data.cantidad,\n        data.ubicacion_fisica || 'Bodega Central'\n    ];\n\n    return await query(sql, params);\n}\n","// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/components/supply/RestockingTable.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/components/supply/RestockingTable.tsx\",\n    \"default\",\n);\n","// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/components/supply/ReceptionForm.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/components/supply/ReceptionForm.tsx\",\n    \"default\",\n);\n","import { getSuppliers, getRestockingSuggestions, getProducts } from '@/lib/data/supply';\nimport RestockingTable from '@/components/supply/RestockingTable';\nimport ReceptionForm from '@/components/supply/ReceptionForm';\nimport RouteGuard from '@/components/auth/RouteGuard';\n\nexport const dynamic = 'force-dynamic';\n\nexport default async function ProveedoresPage() {\n    const suppliers = await getSuppliers();\n    const suggestions = await getRestockingSuggestions();\n    const products = await getProducts();\n\n    return (\n        <RouteGuard allowedRoles={['ADMIN', 'QUIMICO']}>\n            <div className=\"min-h-screen bg-gray-100 py-8\">\n                <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\n                    <div className=\"md:flex md:items-center md:justify-between mb-8\">\n                        <div className=\"min-w-0 flex-1\">\n                            <h2 className=\"text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight\">\n                                ðŸšš Abastecimiento\n                            </h2>\n                            <p className=\"mt-1 text-sm text-gray-500\">\n                                GestiÃ³n de proveedores y reposiciÃ³n inteligente.\n                            </p>\n                        </div>\n                    </div>\n\n                    <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8\">\n                        {/* Left Column: Restocking Suggestions (2/3 width) */}\n                        <div className=\"lg:col-span-2 space-y-6\">\n                            <div className=\"bg-white shadow sm:rounded-lg p-6\">\n                                <h3 className=\"text-lg font-medium leading-6 text-gray-900 mb-4\">\n                                    Alertas de Stock\n                                </h3>\n                                <RestockingTable suggestions={suggestions} />\n                            </div>\n                        </div>\n\n                        {/* Right Column: Reception Form (1/3 width) */}\n                        <div className=\"lg:col-span-1\">\n                            <ReceptionForm suppliers={suppliers} products={products} />\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </RouteGuard>\n    );\n}\n"],"names":[],"mappings":"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","ignoreList":[1,3,4]}