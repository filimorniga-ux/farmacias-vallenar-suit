module.exports=[14939,e=>{"use strict";var t=e.i(47909),o=e.i(74017),r=e.i(96250),n=e.i(59756),i=e.i(61916),a=e.i(14444),s=e.i(37092),c=e.i(69741),l=e.i(16795),u=e.i(87718),d=e.i(95169),p=e.i(47587),m=e.i(66012),R=e.i(70101),E=e.i(26937),g=e.i(10372),h=e.i(93695);e.i(52474);var f=e.i(220),T=e.i(89171);function C(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}async function $(e,t,o){try{return console.warn("‚ö†Ô∏è  Using STUB XML signing. Implement real signing before production!"),{success:!0,signedXml:`<!--MOCK_SIGNED-->${e}`}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error during signing"}}}async function S(e){try{let t=await e.json(),o={id:"1",rut_emisor:"76.123.456-7",razon_social:"FARMACIAS VALLENAR LTDA",giro:"VENTA AL POR MENOR DE PRODUCTOS FARMACEUTICOS",acteco:477310,certificado_pfx_base64:"MOCK_CERT",certificado_password:"MOCK_PASS",fecha_vencimiento_firma:Date.now()+31536e6,ambiente:"CERTIFICACION",direccionEmisor:"Calle Principal 123",comunaEmisor:"Vallenar"},r={id:"1",tipo_dte:t.tipo,xml_content:"<CAF>MOCK_CAF_CONTENT</CAF>",rango_desde:1,rango_hasta:1e3,folios_usados:42,fecha_carga:Date.now(),active:!0},n=r.rango_desde+r.folios_usados;if(r.folios_usados>=r.rango_hasta-r.rango_desde)return T.NextResponse.json({success:!1,error:"NO_FOLIOS",message:"‚õî No hay folios disponibles. Contacte a Gerencia."},{status:400});let i=t.items.reduce((e,t)=>e+t.precio*t.cantidad,0),a=Math.round(i/1.19),s=Math.round(.19*a),c=t.items.map((e,t)=>({numeroLinea:t+1,nombre:e.nombre,cantidad:e.cantidad,precioUnitario:e.precio,montoTotal:e.precio*e.cantidad})),l={tipo:t.tipo,folio:n,fechaEmision:new Date().toISOString().split("T")[0],rutEmisor:o.rut_emisor,razonSocialEmisor:o.razon_social,giroEmisor:o.giro,acteco:o.acteco,direccionEmisor:o.direccionEmisor,comunaEmisor:o.comunaEmisor,rutReceptor:t.cliente?.rut,razonSocialReceptor:t.cliente?.razonSocial,direccionReceptor:t.cliente?.direccion,comunaReceptor:t.cliente?.comuna,items:c,montoNeto:a,montoExento:0,iva:s,montoTotal:i},u=function(e,t){let{tipo:o,folio:r}=e,n=function(e,t){try{let o=`
        <DD>
            <RE>${e.rutEmisor}</RE>
            <TD>${e.tipoDte}</TD>
            <F>${e.folio}</F>
            <FE>${e.fechaEmision}</FE>
            ${e.rutReceptor?`<RR>${e.rutReceptor}</RR>`:""}
            ${e.razonSocialReceptor?`<RSR>${e.razonSocialReceptor}</RSR>`:""}
            <MNT>${e.monto}</MNT>
            <IT1>${e.itemDescripcion}</IT1>
            <CAF version="1.0">
                ${t.xml_content}
            </CAF>
            <TSTED>${new Date().toISOString()}</TSTED>
        </DD>`,r="MOCK_SIGNATURE_"+Buffer.from(o).toString("base64").substring(0,50),n=`
        <TED version="1.0">
            ${o}
            <FRMT algoritmo="SHA1withRSA">${r}</FRMT>
        </TED>`;return console.warn("‚ö†Ô∏è  Using STUB TED generation. Implement real signing before production!"),n}catch(e){return console.error("Error generating TED:",e),""}}({rutEmisor:e.rutEmisor,tipoDte:o,folio:r,fechaEmision:e.fechaEmision,rutReceptor:e.rutReceptor,razonSocialReceptor:e.razonSocialReceptor,monto:e.montoTotal,itemDescripcion:e.items[0]?.nombre||"Venta"},t);return`<?xml version="1.0" encoding="ISO-8859-1"?>
<DTE version="1.0">
    <Documento ID="DOC_${o}_${r}">
        <Encabezado>
            <IdDoc>
                <TipoDTE>${o}</TipoDTE>
                <Folio>${r}</Folio>
                <FchEmis>${e.fechaEmision}</FchEmis>
            </IdDoc>
            <Emisor>
                <RUTEmisor>${e.rutEmisor}</RUTEmisor>
                <RznSoc>${C(e.razonSocialEmisor)}</RznSoc>
                <GiroEmis>${C(e.giroEmisor)}</GiroEmis>
                <Acteco>${e.acteco}</Acteco>
                ${e.direccionEmisor?`<DirOrigen>${C(e.direccionEmisor)}</DirOrigen>`:""}
                ${e.comunaEmisor?`<CmnaOrigen>${C(e.comunaEmisor)}</CmnaOrigen>`:""}
            </Emisor>
            ${e.rutReceptor?`
            <Receptor>
                <RUTRecep>${e.rutReceptor}</RUTRecep>
                <RznSocRecep>${C(e.razonSocialReceptor||"")}</RznSocRecep>
                ${e.giroReceptor?`<GiroRecep>${C(e.giroReceptor)}</GiroRecep>`:""}
                ${e.direccionReceptor?`<DirRecep>${C(e.direccionReceptor)}</DirRecep>`:""}
                ${e.comunaReceptor?`<CmnaRecep>${C(e.comunaReceptor)}</CmnaRecep>`:""}
            </Receptor>
            `:""}
            <Totales>
                ${e.montoNeto>0?`<MntNeto>${e.montoNeto}</MntNeto>`:""}
                ${e.montoExento>0?`<MntExe>${e.montoExento}</MntExe>`:""}
                <IVA>${e.iva}</IVA>
                <MntTotal>${e.montoTotal}</MntTotal>
            </Totales>
        </Encabezado>
        <Detalle>
            ${e.items.map(e=>`
            <Item>
                <NroLinDet>${e.numeroLinea}</NroLinDet>
                <NmbItem>${C(e.nombre)}</NmbItem>
                <QtyItem>${e.cantidad}</QtyItem>
                <PrcItem>${e.precioUnitario}</PrcItem>
                <MontoItem>${e.montoTotal}</MontoItem>
            </Item>
            `).join("")}
        </Detalle>
        ${n}
    </Documento>
</DTE>`}(l,r),d=await $(u,o.certificado_pfx_base64,o.certificado_password);if(!d.success)return T.NextResponse.json({success:!1,error:"SIGNATURE_ERROR",message:d.error},{status:500});let p=`TRACK_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;return console.log("üì§ DTE enviado al SII (MOCK):",{tipo:t.tipo,folio:n,trackId:p,total:i}),console.log("üì¶ Stock actualizado (MOCK)"),T.NextResponse.json({success:!0,data:{tipo:t.tipo,folio:n,trackId:p,fecha:l.fechaEmision,total:i,xml:d.signedXml,pdfUrl:`/api/sii/pdf/${t.tipo}/${n}`}})}catch(e){return console.error("Error emitiendo DTE:",e),T.NextResponse.json({success:!1,error:"INTERNAL_ERROR",message:e instanceof Error?e.message:"Error desconocido"},{status:500})}}e.s(["POST",()=>S],48627);var D=e.i(48627);let _=new t.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/sii/emitir/route",pathname:"/api/sii/emitir",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/sii/emitir/route.ts",nextConfigOutput:"",userland:D}),{workAsyncStorage:A,workUnitAsyncStorage:v,serverHooks:I}=_;function N(){return(0,r.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:v})}async function w(e,t,r){_.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let T="/api/sii/emitir/route";T=T.replace(/\/index$/,"")||"/";let C=await _.prepare(e,t,{srcPage:T,multiZoneDraftMode:!1});if(!C)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:$,params:S,nextConfig:D,parsedUrl:A,isDraftMode:v,prerenderManifest:I,routerServerContext:N,isOnDemandRevalidate:w,revalidateOnlyGenerated:O,resolvedPathname:x,clientReferenceManifest:M,serverActionsManifest:b}=C,y=(0,c.normalizeAppPath)(T),U=!!(I.dynamicRoutes[y]||I.routes[x]),P=async()=>((null==N?void 0:N.render404)?await N.render404(e,t,A,!1):t.end("This page could not be found"),null);if(U&&!v){let e=!!I.routes[x],t=I.dynamicRoutes[y];if(t&&!1===t.fallback&&!e){if(D.experimental.adapterPath)return await P();throw new h.NoFallbackError}}let F=null;!U||_.isDev||v||(F="/index"===(F=x)?"/":F);let z=!0===_.isDev||!U,H=U&&!z;b&&M&&(0,a.setReferenceManifestsSingleton)({page:T,clientReferenceManifest:M,serverActionsManifest:b,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:b})});let k=e.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),q={params:S,prerenderManifest:I,renderOpts:{experimental:{authInterrupts:!!D.experimental.authInterrupts},cacheComponents:!!D.cacheComponents,supportsDynamicResponse:z,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:D.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,o,r)=>_.onRequestError(e,t,r,N)},sharedContext:{buildId:$}},j=new l.NodeNextRequest(e),G=new l.NodeNextResponse(t),V=u.NextRequestAdapter.fromNodeNextRequest(j,(0,u.signalFromNodeResponse)(t));try{let a=async e=>_.handle(V,q).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let o=K.getRootSpanAttributes();if(!o)return;if(o.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${o.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=o.get("next.route");if(r){let t=`${k} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${k} ${T}`)}),s=!!(0,n.getRequestMeta)(e,"minimalMode"),c=async n=>{var i,c;let l=async({previousCacheEntry:o})=>{try{if(!s&&w&&O&&!o)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await a(n);e.fetchMetrics=q.renderOpts.fetchMetrics;let c=q.renderOpts.pendingWaitUntil;c&&r.waitUntil&&(r.waitUntil(c),c=void 0);let l=q.renderOpts.collectedTags;if(!U)return await (0,m.sendResponse)(j,G,i,q.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,R.toNodeOutgoingHttpHeaders)(i.headers);l&&(t[g.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let o=void 0!==q.renderOpts.collectedRevalidate&&!(q.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&q.renderOpts.collectedRevalidate,r=void 0===q.renderOpts.collectedExpire||q.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:q.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:o,expire:r}}}}catch(t){throw(null==o?void 0:o.isStale)&&await _.onRequestError(e,t,{routerKind:"App Router",routePath:T,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:w})},N),t}},u=await _.handleResponse({req:e,nextConfig:D,cacheKey:F,routeKind:o.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:I,isRoutePPREnabled:!1,isOnDemandRevalidate:w,revalidateOnlyGenerated:O,responseGenerator:l,waitUntil:r.waitUntil,isMinimalMode:s});if(!U)return null;if((null==u||null==(i=u.value)?void 0:i.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(c=u.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",w?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),v&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,R.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&U||d.delete(g.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,E.getCacheControlHeader)(u.cacheControl)),await (0,m.sendResponse)(j,G,new Response(u.value.body,{headers:d,status:u.value.status||200})),null};L?await c(L):await K.withPropagatedContext(e.headers,()=>K.trace(d.BaseServerSpan.handleRequest,{spanName:`${k} ${T}`,kind:i.SpanKind.SERVER,attributes:{"http.method":k,"http.target":e.url}},c))}catch(t){if(t instanceof h.NoFallbackError||await _.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:w})}),U)throw t;return await (0,m.sendResponse)(j,G,new Response(null,{status:500})),null}}e.s(["handler",()=>w,"patchFetch",()=>N,"routeModule",()=>_,"serverHooks",()=>I,"workAsyncStorage",()=>A,"workUnitAsyncStorage",()=>v],14939)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_e0ef73e3.js.map